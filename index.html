<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bike LED Nav (WebBLE → Pico W)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    header, footer { padding: 8px 12px; background:#f4f4f4; }
    #map { height: 50vh; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #666; }
    .row { display:flex; gap:8px; padding:8px; flex-wrap:wrap; }
    input[type=text]{ flex:1; padding:8px; }
    button{ padding:8px 12px; }
    pre{ background:#eee; padding:8px; overflow:auto; max-height: 100px; }
  </style>
</head>
<body>
<header>
  <strong>Bike LED Nav</strong> — Google Directions → Web Bluetooth → Pico W
</header>
<div class="row">
  <input id="apiKey" type="text" placeholder="Google Maps APIキーを入力してください"/>
  <button id="setApiKeyBtn">APIキー設定 & 地図読込</button>
</div>
<div class="row">
  <input id="origin" type="text" placeholder="出発地（空欄で現在地）"/>
  <input id="destination" type="text" placeholder="目的地（住所/名称）"/>
</div>
<div class="row">
  <button id="routeBtn">経路取得</button>
  <button id="connectBtn">Pico Wに接続</button>
  <button id="startNavBtn">ナビ開始</button>
  <button id="stopNavBtn">ナビ停止</button>
</div>
<div id="map">地図を読み込むには、APIキーを設定してください</div>
<pre id="log"></pre>
<script>
// ====== 設定 (UUID) ======
const SERVICE_UUID = '0000feed-0000-1000-8000-00805f9b34fb';
const NAV_CHAR_UUID = '0000feed-0001-1000-8000-00805f9b34fb';

// ====== 変数 ======
let map, directionsService, directionsRenderer;
let steps = [];
let currentStepIdx = 0;
let navChar = null;
let watchId = null;
let isMapApiLoaded = false;

// ====== ログ表示関数 ======
function log(...args){
  const el = document.getElementById('log');
  el.textContent += args.join(' ') + '\n';
  el.scrollTop = el.scrollHeight;
}

// ====== Google Maps 初期化 ======
// Google Mapsスクリプトのコールバックによって呼び出される
window.initMap = function(){
  log('Google Maps APIの読み込みが完了しました。');
  isMapApiLoaded = true;
  document.getElementById('map').textContent = ''; // プレースホルダーテキストをクリア
  map = new google.maps.Map(document.getElementById('map'), { center: {lat:35.681236, lng:139.767125}, zoom: 13 });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map });
}

function loadGoogleMapsApi() {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) {
    alert('APIキーを入力してください。');
    return;
  }
  
  const existingScript = document.getElementById('googleMapsScript');
  if (existingScript) {
    existingScript.remove();
  }

  const script = document.createElement('script');
  script.id = 'googleMapsScript';
  script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
  script.async = true;
  script.defer = true;
  script.onerror = () => {
    log('Google Maps APIの読み込みに失敗しました。APIキーとネットワーク接続を確認してください。');
    alert('Google Maps APIの読み込みに失敗しました。APIキーが正しいか、もしくはネットワーク接続を確認してください。');
  };
  document.head.appendChild(script);
  log('Googleマップを読み込んでいます...');
}


// ====== ルート検索API ======
async function fetchRoute(){
  if (!isMapApiLoaded) {
    alert('先にAPIキーを設定して地図を読み込んでください。');
    return;
  }
  const originInput = document.getElementById('origin').value.trim();
  const dest = document.getElementById('destination').value.trim();
  if(!dest){ alert('目的地を入力してください。'); return; }
  let originPromise;
  if(originInput){
    originPromise = Promise.resolve(originInput);
  } else {
    originPromise = new Promise((resolve, reject)=>{
      navigator.geolocation.getCurrentPosition(
        resolve,
        reject,
        {enableHighAccuracy:true, maximumAge:0, timeout:10000}
      );
    });
  }
  try {
    const position = await originPromise;
    const origin = originInput ? originInput : {lat: position.coords.latitude, lng: position.coords.longitude};
    
    const request = {
      origin: origin,
      destination: dest,
      travelMode: google.maps.TravelMode.DRIVING,
      provideRouteAlternatives: false
    };
    directionsService.route(request, (result, status) => {
      if(status === google.maps.DirectionsStatus.OK){
        log('経路取得に成功しました。'); // ★ご依頼のログを追加
        directionsRenderer.setDirections(result);
        const leg = result.routes[0].legs[0];
        steps = leg.steps.map((s, i)=> ({
          index: i,
          end: {lat: s.end_location.lat(), lng: s.end_location.lng()},
          distance: s.distance && s.distance.value || 0,
          maneuver: s.maneuver || 'straight',
          html: s.instructions
        }));
        currentStepIdx = 0;
        log('ステップ数:', steps.length);
      } else {
        log('ルート検索エラー:', status);
        alert('経路取得に失敗しました: ' + status);
      }
    });
  } catch (err) {
    let errorMessage = '現在地の取得に失敗しました。';
    if (err && err.message) {
        log(`現在地取得エラー: ${err.message} (コード: ${err.code})`);
    }

    switch(err.code) {
        case 1: // PERMISSION_DENIED
            errorMessage += '\n理由: 位置情報へのアクセスが拒否されました。ブラウザまたは端末の設定を確認してください。';
            break;
        case 2: // POSITION_UNAVAILABLE
            errorMessage += '\n理由: 現在地を特定できませんでした。GPSの電波が良い場所で再度お試しください。';
            break;
        case 3: // TIMEOUT
            errorMessage += '\n理由: 現在地の取得がタイムアウトしました。';
            break;
        default:
             errorMessage += `\n理由: ${err.message}`;
    }
    
    alert