<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bike LED Nav (WebBLE → Pico W)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    header, footer { padding: 8px 12px; background:#f4f4f4; }
    #map { height: 50vh; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #666; }
    .row { display:flex; gap:8px; padding:8px; flex-wrap:wrap; }
    input[type=text]{ flex:1; padding:8px; }
    button{ padding:8px 12px; }
    pre{ background:#eee; padding:8px; overflow:auto; max-height: 100px; }
  </style>
</head>
<body>
<header>
  <strong>Bike LED Nav</strong> — Google Directions → Web Bluetooth → Pico W
</header>
<div class="row">
  <input id="apiKey" type="text" placeholder="Google Maps APIキーを入力してください"/>
  <button id="setApiKeyBtn">APIキー設定 & 地図読込</button>
</div>
<div class="row">
  <input id="origin" type="text" placeholder="出発地（空欄で現在地）"/>
  <input id="destination" type="text" placeholder="目的地（住所/名称）"/>
</div>
<div class="row">
  <button id="routeBtn">経路取得</button>
  <button id="connectBtn">Pico Wに接続</button>
  <button id="startNavBtn">ナビ開始</button>
  <button id="stopNavBtn">ナビ停止</button>
</div>
<div id="map">地図を読み込むには、APIキーを設定してください</div>
<pre id="log"></pre>
<script>
// ====== 設定 (UUID) ======
const SERVICE_UUID = '0000feed-0000-1000-8000-00805f9b34fb';
const NAV_CHAR_UUID = '0000feed-0001-1000-8000-00805f9b34fb';

// ====== 変数 ======
let map, directionsService, directionsRenderer;
let steps = [];
let currentStepIdx = 0;
let navChar = null;
let watchId = null;
let isMapApiLoaded = false;

// ====== ログ表示関数 ======
function log(...args){
  const el = document.getElementById('log');
  el.textContent += args.join(' ') + '\n';
  el.scrollTop = el.scrollHeight;
}

// ====== Google Maps 初期化 ======
// Google Mapsスクリプトのコールバックによって呼び出される
window.initMap = function(){
  log('Google Maps APIの読み込みが完了しました。');
  isMapApiLoaded = true;
  document.getElementById('map').textContent = ''; // プレースホルダーテキストをクリア
  map = new google.maps.Map(document.getElementById('map'), { center: {lat:35.681236, lng:139.767125}, zoom: 13 });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map });
}

function loadGoogleMapsApi() {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) {
    alert('APIキーを入力してください。');
    return;
  }
  
  const existingScript = document.getElementById('googleMapsScript');
  if (existingScript) {
    existingScript.remove();
  }

  const script = document.createElement('script');
  script.id = 'googleMapsScript';
  script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
  script.async = true;
  script.defer = true;
  script.onerror = () => {
    log('Google Maps APIの読み込みに失敗しました。APIキーとネットワーク接続を確認してください。');
    alert('Google Maps APIの読み込みに失敗しました。APIキーが正しいか、もしくはネットワーク接続を確認してください。');
  };
  document.head.appendChild(script);
  log('Googleマップを読み込んでいます...');
}


// ====== ルート検索API ======
async function fetchRoute(){
  if (!isMapApiLoaded) {
    alert('先にAPIキーを設定して地図を読み込んでください。');
    return;
  }
  const originInput = document.getElementById('origin').value.trim();
  const dest = document.getElementById('destination').value.trim();
  if(!dest){ alert('目的地を入力してください。'); return; }
  let originPromise;
  if(originInput){
    originPromise = Promise.resolve(originInput);
  } else {
    originPromise = new Promise((resolve, reject)=>{
      navigator.geolocation.getCurrentPosition(
        resolve,
        reject,
        {enableHighAccuracy:true, maximumAge:0, timeout:10000}
      );
    });
  }
  try {
    const position = await originPromise;
    const origin = originInput ? originInput : {lat: position.coords.latitude, lng: position.coords.longitude};
    
    const request = {
      origin: origin,
      destination: dest,
      travelMode: google.maps.TravelMode.DRIVING,
      provideRouteAlternatives: false
    };
    directionsService.route(request, (result, status) => {
      if(status === google.maps.DirectionsStatus.OK){
        log('経路取得に成功しました。');
        directionsRenderer.setDirections(result);
        const leg = result.routes[0].legs[0];
        steps = leg.steps.map((s, i)=> ({
          index: i,
          end: {lat: s.end_location.lat(), lng: s.end_location.lng()},
          distance: s.distance && s.distance.value || 0,
          maneuver: s.maneuver || 'straight',
          html: s.instructions
        }));
        currentStepIdx = 0;
      } else {
        log('ルート検索エラー:', status);
        alert('経路取得に失敗しました: ' + status);
      }
    });
  } catch (err) {
    let errorMessage = '現在地の取得に失敗しました。';
    if (err && err.message) {
        log(`現在地取得エラー: ${err.message} (コード: ${err.code})`);
    }

    switch(err.code) {
        case 1: // PERMISSION_DENIED
            errorMessage += '\n理由: 位置情報へのアクセスが拒否されました。ブラウザまたは端末の設定を確認してください。';
            break;
        case 2: // POSITION_UNAVAILABLE
            errorMessage += '\n理由: 現在地を特定できませんでした。GPSの電波が良い場所で再度お試しください。';
            break;
        case 3: // TIMEOUT
            errorMessage += '\n理由: 現在地の取得がタイムアウトしました。';
            break;
        default:
             errorMessage += `\n理由: ${err.message}`;
    }
    
    alert(errorMessage + '\n\n出発地を直接入力してください。');
  }
}

// ====== Maneuverコードへの変換 ======
function toManeuverCode(m){
  const k = (m||'').toLowerCase();
  if(k.includes('uturn')) return 0x08;
  if(k.includes('roundabout') && k.includes('left')) return 0x09;
  if(k.includes('roundabout') && k.includes('right')) return 0x0A;
  if(k.includes('sharp') && k.includes('left')) return 0x04;
  if(k.includes('sharp') && k.includes('right')) return 0x07;
  if(k.includes('slight') && k.includes('left')) return 0x02;
  if(k.includes('slight') && k.includes('right')) return 0x05;
  if(k.includes('merge') || k.includes('ramp') || k.includes('fork')){
    return 0x01;
  }
  if(k.includes('left')) return 0x03;
  if(k.includes('right')) return 0x06;
  return 0x01; // デフォルトは直進
}

// ====== BLE接続 ======
async function connectToPico(){
  if(!('bluetooth' in navigator)){ alert('このブラウザはWeb Bluetoothに対応していません。'); return; }
  try {
    log('Bluetoothデバイスを検索しています...');
    const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
    log('デバイスを発見しました。...');
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    navChar = await service.getCharacteristic(NAV_CHAR_UUID);
    log('Pico Wへの接続に成功しました。');
  } catch(error) {
    log(`Bluetooth接続エラー: ${error.name} - ${error.message}`);
    alert(`Bluetooth接続に失敗しました: ${error.message}`);
  }
}

// ====== コマンドの作成と送信 ======
function buildNavCommand(stepIndex, maneuverCode, distMeters){
  const buf = new ArrayBuffer(8);
  const dv = new DataView(buf);
  dv.setUint8(0, 0x01); // version
  dv.setUint8(1, 0x01); // Message Type: NEXT_STEP
  dv.setUint16(2, stepIndex, false); // big-endian
  dv.setUint8(4, maneuverCode);
  dv.setUint16(5, Math.max(0, Math.min(65535, Math.round(distMeters||0))), false); // big-endian
  dv.setUint8(7, 0x00); // reserved
  return buf;
}
async function sendStep(idx, dist){
  if(!navChar){ log('Pico Wに接続されていません。'); return; }
  const st = steps[idx];
  if(!st){ log('ステップデータがありません。'); return; }
  const code = toManeuverCode(st.maneuver);
  const cmd = buildNavCommand(idx, code, dist);
  try {
    await navChar.writeValue(cmd);
    log('ステップ送信:', idx, st.maneuver, '距離=', Math.round(dist), 'm');
  } catch (error) {
    log(`ステップの送信に失敗しました: ${error.message}`);
  }
}

// ====== ナビゲーションのロジック ======
function haversineMeters(a, b){
  const toRad = d => d*Math.PI/180;
  const R = 6371000; // 地球の半径 (メートル)
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const sinDlat = Math.sin(dLat/2), sinDlng = Math.sin(dLng/2);
  const h = sinDlat*sinDlat + Math.cos(lat1)*Math.cos(lat2)*sinDlng*sinDlng;
  return 2*R*Math.asin(Math.sqrt(h));
}

function startNav(){
  if(!steps.length){ alert('先に経路を取得してください。'); return; }
  if(watchId) navigator.geolocation.clearWatch(watchId);
  
  watchId = navigator.geolocation.watchPosition(pos => {
    const cur = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    if (currentStepIdx >= steps.length) {
        log("ナビを終了します。");
        stopNav();
        return;
    }
    const st = steps[currentStepIdx];
    const dist = haversineMeters(cur, st.end);

    // 50m未満で指示を送信
    if(dist < 50){
      sendStep(currentStepIdx, dist);
    }
    // 30m未満で次のステップへ
    if(dist < 30 && currentStepIdx < steps.length-1){
      currentStepIdx++;
      log("次のステップへ進みます:", currentStepIdx);
      // すぐに次のステップ情報を送信
      const nextStep = steps[currentStepIdx];
      const distToNext = haversineMeters(cur, nextStep.end);
      sendStep(currentStepIdx, distToNext);
    }
  }, err => {
    log(`現在地の追跡エラー: ${err.message} (コード: ${err.code})`);
  }, {enableHighAccuracy:true, maximumAge:1000, timeout:15000});
  
  log('ナビを開始します。');
}

function stopNav(){
  if(watchId){ 
    navigator.geolocation.clearWatch(watchId); 
    watchId = null; 
  }
  if(navChar){
    const buf = new ArrayBuffer(8);
    const dv = new DataView(buf);
    dv.setUint8(0, 0x01); // version
    dv.setUint8(1, 0x02); // Message Type: CANCEL/STOP
    dv.setUint16(2, 0, false);
    dv.setUint8(4, 0xFF);
    dv.setUint16(5, 0, false);
    dv.setUint8(7, 0x00);
    navChar.writeValue(buf).catch(err => log("停止コマンドの送信エラー:", err));
  }
  log('ナビを停止します。');
}

// ====== イベントリスナー ======
document.getElementById('setApiKeyBtn').addEventListener('click', loadGoogleMapsApi);
document.getElementById('routeBtn').addEventListener('click', fetchRoute);
document.getElementById('connectBtn').addEventListener('click', connectToPico);
document.getElementById('startNavBtn').addEventListener('click', startNav);
document.getElementById('stopNavBtn').addEventListener('click', stopNav);

</script>
</body>
</html>